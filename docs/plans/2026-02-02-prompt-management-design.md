# Дизайн системы управления промптами

## Обзор
Система предназначена для централизованного хранения, версионирования и динамического рендеринга промптов для LLM. Система рассматривает промпты как версионируемые артефакты, позволяя управлять ими без изменения программного кода.

## Архитектура

### 1. Структура файлов и Реестр
Все ресурсы сосредоточены в папке `prompts/`:
- `prompts/registry.yaml`: Глобальный реестр промптов. Связывает `prompt_id` с конкретными версиями и путями к файлам.
- `prompts/common/`: Базовые шаблоны и фрагменты (стиль, правила безопасности).
- `prompts/agents/`: Шаблоны для конкретных агентов.

### 2. Технологический стек
- **Jinja2**: Движок шаблонизации с поддержкой наследования и логики.
- **PyYAML**: Для работы с реестром.
- **Python Manager**: Класс `PromptManager` в `src/prompt_manager.py`.

### 3. Основные концепции

#### Версионирование и Pinning
- Каждый промпт имеет уникальный `prompt_id` (например, `research_agent`).
- Реестр определяет `active_version` для каждого ID.
- Поддержка "пина" версии через ENV: `PROMPT_RESEARCH_AGENT_VERSION=v2` перекрывает значение из реестра.
- Это позволяет выполнять откаты и A/B тесты простым изменением конфига или окружения.

#### PromptManager
- **Рендеринг**: Вызов по ID: `render("research_agent", **data)`.
- **Strict Mode**: Использование `jinja2.StrictUndefined`. Ошибка при попытке рендеринга с отсутствующими переменными.
- **Безопасное логирование**:
    - В логи пишутся метаданные: `timestamp`, `prompt_id`, `version`, `input_keys`.
    - Текст промпта маскируется (PII/секреты) перед записью.
    - Полное логирование включается только через `DEBUG_PROMPTS=true`.

## Потоки данных
1. Код запрашивает промпт по ID.
2. `PromptManager` находит путь к файлу через Реестр (учитывая ENV перекрытия).
3. Шаблон рендерится через Jinja2 с проверкой на полноту данных.
4. Метаданные рендеринга логируются.
5. Результат передается в LLM.

## Обработка ошибок
- `PromptRegistryError`: Ошибка в структуре реестра или отсутствие ID.
- `TemplateNotFound`: Если файл версии не найден по указанному пути.
- `UndefinedError`: Пропущены обязательные переменные шаблона.

## Тестирование
- Валидация реестра (все пути существуют, версии уникальны).
- Тесты на перекрытие версий через ENV.
- Тесты маскирования чувствительных данных в логах.
