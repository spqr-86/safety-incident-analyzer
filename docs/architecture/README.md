# Codebase Analysis

## ‚ö° TL;DR

**–ß—Ç–æ —ç—Ç–æ:** RAG-—Å–∏—Å—Ç–µ–º–∞ —Å –º—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∫–∞—á–µ—Å—Ç–≤–∞ (LangGraph) –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º (Chroma + BM25 + FlashRank).

**–¢–æ–ø-3 –∫–æ–º–∞–Ω–¥—ã:**
1. `python index.py` ‚Äî –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
2. `streamlit run app.py` ‚Äî –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
3. `pytest` ‚Äî –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

**–ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:** `agents/workflow.py`, `src/final_chain.py`, `index.py`

---

## ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **LangGraph** –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–æ–≤. –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```mermaid
sequenceDiagram
    participant User
    participant Workflow as AgentWorkflow
    participant Relevance as RelevanceChecker
    participant Research as ResearchAgent
    participant Verify as VerificationAgent

    User->>Workflow: –ó–∞–ø—Ä–æ—Å
    Workflow->>Relevance: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    alt Irrelevant
        Relevance-->>Workflow: CANNOT_ANSWER
        Workflow-->>User: –û—Ç–∫–∞–∑
    else Relevant
        Relevance-->>Workflow: CAN_ANSWER / PARTIAL
        loop Research Loop (Max 2)
            Workflow->>Research: –ü–æ–∏—Å–∫ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞
            Research-->>Workflow: –ß–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞
            Workflow->>Verify: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤
            alt Good
                Verify-->>Workflow: CORRECT
                Workflow-->>User: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
            else Bad
                Verify-->>Workflow: REVISE (–ó–∞–º–µ—á–∞–Ω–∏—è)
                Note right of Workflow: –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
            end
        end
    end
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç—Ç–∞–ø—ã

| Step | Component | Action |
|------|-----------|--------|
| 1. Ingestion | `index.py` | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ ChromaDB |
| 2. Retrieval | `src/final_chain.py` | –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —á–∞–Ω–∫–æ–≤ (Hybrid + Rerank) |
| 3. Relevance Check | `agents/relevance_checker.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ–º–µ |
| 4. Generation | `agents/research_agent.py` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ |
| 5. Verification | `agents/verification_agent.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π |

---

## üöÄ –ü–µ—Ä–≤—ã–µ —à–∞–≥–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python index.py          # –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
streamlit run app.py     # –ó–∞–ø—É—Å–∫ UI
```

### –¢–∏–ø–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

**–•–æ—á—É –ø–æ–Ω—è—Ç—å [RAG]:**
–ò–∑—É—á–∏—Ç–µ `src/final_chain.py`, —á—Ç–æ–±—ã —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –º–µ—Ö–∞–Ω–∏–∫–µ –ø–æ–∏—Å–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

**–•–æ—á—É –ø–æ–Ω—è—Ç—å [Agents]:**
–°–º–æ—Ç—Ä–∏—Ç–µ `agents/workflow.py` –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –≥—Ä–∞—Ñ–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π.

**–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ–∏—á—É:**
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –≤ `agents/`.
2. –î–æ–±–∞–≤—å—Ç–µ —É–∑–µ–ª (node) –≤ –≥—Ä–∞—Ñ –≤ `agents/workflow.py`.

**–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ `analysis/error_reports`.
2. –ù–∞–ø–∏—à–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—â–∏–π —Ç–µ—Å—Ç –≤ `tests/`.

**–ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç:**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `pytest`. –¢–µ—Å—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `tests/`. –°–º. –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤ [testing.md](../guides/testing.md).

**–•–æ—á—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:**
–°–º. [testing.md](../guides/testing.md) –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Å—ã–ª–æ–∫ –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏.

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (Deploy)
- **Streamlit Cloud:** –ü–æ–¥–∫–ª—é—á–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π GitHub –∏ —É–∫–∞–∂–∏—Ç–µ `app.py`.
- **Docker:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `Dockerfile` –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏.

---

## üó∫ –ö–∞—Ä—Ç–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

| –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `agents/` | –õ–æ–≥–∏–∫–∞ –º—É–ª—å—Ç–∏-–∞–≥–µ–Ω—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (LangGraph). –°–æ–¥–µ—Ä–∂–∏—Ç `RelevanceChecker`, `ResearchAgent`, `VerificationAgent`. |
| `src/` | –Ø–¥—Ä–æ RAG-–ª–æ–≥–∏–∫–∏: —Ü–µ–ø–æ—á–∫–∏ (`final_chain.py`), —Ä–∞–±–æ—Ç–∞ —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –ë–î (`vector_store.py`), —Ñ–∞–±—Ä–∏–∫–∏ LLM. |
| `config/` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (`settings.py`). |
| `eval/` | –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ (DeepEval, Ragas). |
| `tests/` | –Æ–Ω–∏—Ç –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã. |
| `analysis/` | –û—Ç—á–µ—Ç—ã –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ª–æ–≥–∏ —Ä–∞–±–æ—Ç—ã. |

---

## üî¨ –£–≥–ª—É–±–ª—ë–Ω–Ω–æ

<details>
<summary><b>–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã (20 —à–∞–≥–æ–≤)</b></summary>

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å.
2. –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∞.
3. `RelevanceChecker` –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å.
4. LLM –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª–∞—Å—Å –∑–∞–ø—Ä–æ—Å–∞ (Relevant/Not).
5. –ï—Å–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ -> –æ—Ç–≤–µ—Ç-–∑–∞–≥–ª—É—à–∫–∞.
6. –ï—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ -> –ø–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è `ResearchAgent`.
7. `ResearchAgent` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.
8. Retriever –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ ChromaDB (–≤–µ–∫—Ç–æ—Ä–Ω—ã–π).
9. Retriever –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ BM25 (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞).
10. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è (Ensemble Retriever).
11. FlashRank –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏.
12. –¢–æ–ø-K –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
13. LLM –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç–≤–µ—Ç–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É.
14. –û—Ç–≤–µ—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `VerificationAgent`.
15. `VerificationAgent` —Å–≤–µ—Ä—è–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
16. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (Correctness/Faithfulness).
17. –ï—Å–ª–∏ –æ—Ü–µ–Ω–∫–∞ –≤—ã—Å–æ–∫–∞—è -> –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞.
18. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ -> —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–¥–±–µ–∫–∞.
19. –í–æ–∑–≤—Ä–∞—Ç –∫ `ResearchAgent` (—Ü–∏–∫–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –º–∞–∫—Å. 2 —Ä–∞–∑–∞).
20. –§–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

</details>

### Known Issues / TODO
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ FlashRank (–∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ CPU).
- [ ] –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü –≤ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.
- [ ] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –¥–∏–∞–ª–æ–≥–∞ (Chat History) –≤ LangGraph.
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤.

### Relevance Checker
–ü–µ—Ä–≤—ã–π —Ä—É–±–µ–∂ –æ–±–æ—Ä–æ–Ω—ã. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
- `CAN_ANSWER`: –í–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ –æ—Ö—Ä–∞–Ω—ã —Ç—Ä—É–¥–∞.
- `PARTIAL`: –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ —Ç–µ–º–µ, —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è.
- `NO`: –í–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ (—Å–ø–∞–º, chit-chat).

### Verification Agent
–ö—Ä–∏—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º (–∫–æ–Ω—Ç–µ–∫—Å—Ç—É).
- –ï—Å–ª–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π –Ω–µ—Ç -> –æ—Ç–≤–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ -> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å —É–∫–∞–∑–∞–Ω–∏–µ–º, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å.
